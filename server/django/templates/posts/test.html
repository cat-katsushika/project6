<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to record a video with JavaScript</title>
</head>

<body>
    <div>
        {{ error }}
    </div>
    <div>
        <button type="button" id="buttonStart" style="width: 300px; height: 100px;">Start</button>
        <!-- <button type="button" id="buttonStop" style="width: 300px; height: 100px;" disabled>Stop</button> -->
        <div id="logText"></div>
    </div>
    <div>
        <video autoplay muted playsinline id="videoLive" style="width: 300px; height: 300px;"></video>
    </div>
    <div>
        <video controls playsinline id="videoRecorded" style="width: 300px; height: 300px;"></video>
    </div>

    {% if form_errors %}
    <div>
        <ul>
            {% for field, errors in form_errors.items %}
                <li>{{ field }}:
                    <ul>
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

    {{ form.as_p }}

    <form id="uploadForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- ファイル入力（非表示） -->
        <input type="file" id="videoFile" name="video_file" accept="video/*" style="display:none;">
        <input type="file" id="thumbnailFile" name="thumbnail_file" accept="image/*" style="display:none;">
        <!-- 位置情報入力（非表示） -->
        <input type="text" id="latitude" name="latitude" style="display:none;">
        <input type="text" id="longitude" name="longitude" style="display:none;">
        <!-- アップロードボタン（初期状態では無効化） -->
        <button type="button" id="uploadButton" style="width: 300px; height: 100px;" disabled>Upload Video</button>
    </form>

    <!-- サムネイル生成用のcanvas（非表示） -->
    <!-- <canvas id="thumbnailCanvas" style="display:none;"></canvas> -->
    <canvas id="thumbnailCanvas" style="width: 20px; height: 20px;"></canvas>


    <script>
        async function main() {
            // 各要素を取得
            const buttonStart = document.querySelector('#buttonStart')
            const videoLive = document.querySelector('#videoLive')
            const videoRecorded = document.querySelector('#videoRecorded')

            // formの要素
            const uploadForm = document.getElementById('uploadForm');
            const videoFileInput = document.getElementById('videoFile');
            const thumbnailFileInput = document.getElementById('thumbnailFile');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const uploadButton = document.getElementById('uploadButton');

            // サムネイル生成用のcanvas
            const thumbnailCanvas = document.getElementById('thumbnailCanvas');
            const thumbnailContext = thumbnailCanvas.getContext('2d');


            const logText = document.querySelector('#logText')

            // ビデオの読み込みが完了するまで待機する関数
            function waitForLoadedData(videoElement) {
                return new Promise((resolve) => {
                    videoElement.addEventListener('loadeddata', () => {
                        try {
                            thumbnailCanvas.width = videoRecorded.videoWidth;
                            thumbnailCanvas.height = videoRecorded.videoHeight;
                        } catch (error) {
                            logText.textContent += 'キャンバスのサイズを設定できませんでした。' + error;
                        }
                        logText.textContent += 'キャンバスのサイズを設定しました' + thumbnailCanvas.width + 'x' + thumbnailCanvas.height;
                        
                        try {
                            thumbnailContext.drawImage(videoRecorded, 0, 0, videoRecorded.videoWidth, videoRecorded.videoHeight);
                        } catch (error) {
                            logText.textContent += 'イメージを描画できませんでした。' + error;
                        }

                        logText.textContent += 'イメージを描画しました。'

                        resolve();
                    }, { once: true }); // once: true ensures the event listener is removed after it triggers
                });
            }

            // カメラ映像を取得
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 720 },
                    height: { ideal: 720 },
                    facingMode: { exact: 'environment' },
                },
                audio: true,
            }).catch(error => {
                buttonStart.setAttribute('disabled', '')
                buttonStart.innerHTML = '要件を満たす動画撮影用デバイスを取得できませんでした'
                logText.textContent = error
            })

            // カメラ映像を表示
            videoLive.srcObject = stream

            // video/mp4がサポートされていない場合はエラーメッセージを表示
            if (!MediaRecorder.isTypeSupported('video/mp4')) {
                logText.textContent = 'video/mp4 is not supported'
            }

            // MediaRecorderを生成
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/mp4',
            })

            // uploadButtonを押したときの処理
            uploadButton.addEventListener('click', () => {
                uploadForm.submit();
            })


            // 録画ボタンを押したときの処理
            buttonStart.addEventListener('click', () => {
                logText.textContent = 'click start button'
                mediaRecorder.start()
                buttonStart.setAttribute('disabled', '')
                logText.textContent += 'start recording'

                // 3秒後に録画を停止
                setTimeout(stopRecording, 3000);
            })


            // 録画を停止する関数
            function stopRecording() {
                mediaRecorder.stop()
                buttonStart.removeAttribute('disabled')
                logText.textContent = 'stop recording'
            }

            function getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve(position);
                        },
                        (error) => {
                            reject(error);
                        }
                    );
                });
            }

            // 録画が終了したときの処理
            mediaRecorder.addEventListener('dataavailable', async event => {
                // 現在地を取得
                try {
                    const position = await getCurrentPosition();
                    logText.textContent += 'latitude: ' + position.coords.latitude + ', longitude: ' + position.coords.longitude;
                    latitudeInput.value = position.coords.latitude;
                    longitudeInput.value = position.coords.longitude;
                } catch (error) {
                    alert('位置情報を取得できませんでした。位置情報が必要です。');
                    logText.textContent += '位置情報を取得できませんでした。位置情報が必要です。' + error;
                }

                logText.textContent += '現在地を取得しました。'

                const videoBlob = new Blob([event.data], { type: 'video/mp4' });
                const videoURL = URL.createObjectURL(videoBlob);
                
                // 録画した動画を表示
                videoRecorded.src = videoURL;
                videoRecorded.controls = true;
                videoRecorded.play();

                logText.textContent += '録画した動画を表示しました。'


                logText.textContent += 'サムネイルを生成します。'

                await waitForLoadedData(videoRecorded);

                
                

                
                try {
                    const thumbnailBlob = await canvasToBlob(thumbnailCanvas);
                } catch (error) {
                    logText.textContent += 'サムネイルBlobを生成できませんでした。' + error;
                }

                const thumbnailBlob = await canvasToBlob(thumbnailCanvas);
                // try {
                //     const thumbnailBlob = thumbnailCanvas.toBlob();
                // } catch (error) {
                //     logText.textContent += 'サムネイルBlobを生成できませんでした。' + error;
                // }

                logText.textContent += 'サムネイルBlobを生成しました。'
                
                // Create files for form submission
                try {
                const videoFile = new File([videoBlob], 'recordedVideo.mp4', { type: 'video/mp4' });
                const thumbnailFile = new File([thumbnailBlob], 'thumbnail.png', { type: 'image/png' });
                } catch (error) {
                    logText.textContent += 'ファイルを生成できませんでした。' + error;
                }
                
                // try-catchはブロック内で完結しているため再度実行
                const videoFile = new File([videoBlob], 'recordedVideo.mp4', { type: 'video/mp4' });
                const thumbnailFile = new File([thumbnailBlob], 'thumbnail.png', { type: 'image/png' });



                logText.textContent += 'ファイルを生成しました。'

                // formにファイルをセット

                try {
                    setFileInput(videoFileInput, videoFile);
                    setFileInput(thumbnailFileInput, thumbnailFile);
                } catch (error) {
                    logText.textContent += 'ファイルをセットできませんでした。' + error;
                }

                logText.textContent += 'ファイルをセットしました。'

                // アップロードボタンを有効化
                if (videoFileInput.files.length > 0 && thumbnailFileInput.files.length > 0 && latitudeInput.value && longitudeInput.value) {
                    uploadButton.removeAttribute('disabled');
                } else {
                    uploadButton.setAttribute('disabled', '');
                    logText.textContent += '動画、サムネイル、位置情報のいずれかが取得できていません。もう一度録画してください。';
                    alert('動画、サムネイル、位置情報のいずれかが取得できていません。もう一度録画してください。');
                }

                logText.textContent += 'アップロードボタンを有効化しました。'

            })
        }

        // formにファイルをセットする関数
        function setFileInput(fileInput, file) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        // canvasをBlobに変換する関数
        function canvasToBlob(canvas, type = 'image/png') {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, type);
            });
        }

        // サムネイルを生成する関数
        async function createThumbnail(videoURL) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = videoURL;
                video.addEventListener('loadeddata', () => {
                    const context = thumbnailCanvas.getContext('2d');
                    thumbnailCanvas.width = video.videoWidth;
                    thumbnailCanvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, thumbnailCanvas.width, thumbnailCanvas.height);
                    thumbnailCanvas.toBlob(blob => resolve(blob), 'image/png');
                });
                video.addEventListener('error', reject);
            });
        }



        main()
    </script>
</body>

</html>