<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Selector</title>
</head>
<body>
    <video id="videoLive" autoplay></video>
    <video id="videoRecorded" controls></video>
    <button id="buttonStart">Start Recording</button>
    <button id="buttonStop" disabled>Stop Recording</button>
    <p id="logText"></p>
    <select id="cameraSelect"></select>

    <script>
        async function main() {
            const buttonStart = document.querySelector('#buttonStart')
            const buttonStop = document.querySelector('#buttonStop')
            const videoLive = document.querySelector('#videoLive')
            const videoRecorded = document.querySelector('#videoRecorded')
            const logText = document.querySelector('#logText')
            const cameraSelect = document.querySelector('#cameraSelect')

            const devices = await navigator.mediaDevices.enumerateDevices()
            const videoDevices = devices.filter(device => device.kind === 'videoinput')

            videoDevices.forEach(device => {
                const option = document.createElement('option')
                option.value = device.deviceId
                option.text = device.label || `Camera ${cameraSelect.length + 1}`
                cameraSelect.appendChild(option)
            })

            let stream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: videoDevices[0].deviceId },
                audio: true,
            })

            videoLive.srcObject = stream

            if (!MediaRecorder.isTypeSupported('video/mp4')) {
                console.warn('video/mp4 is not supported')
                logText.textContent = 'video/mp4 is not supported'
            }

            let mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/mp4',
            })

            cameraSelect.addEventListener('change', async () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop())
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: cameraSelect.value },
                    audio: true,
                })

                videoLive.srcObject = stream

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/mp4',
                })
            })

            buttonStart.addEventListener('click', () => {
                logText.textContent = 'click start button'
                mediaRecorder.start()
                buttonStart.setAttribute('disabled', '')
                buttonStop.removeAttribute('disabled')
                logText.textContent = 'start recording'
            })

            buttonStop.addEventListener('click', () => {
                logText.textContent = 'click stop button'
                mediaRecorder.stop()
                buttonStart.removeAttribute('disabled')
                buttonStop.setAttribute('disabled', '')
                logText.textContent = 'stop recording'
            })

            mediaRecorder.addEventListener('dataavailable', event => {
                videoRecorded.src = URL.createObjectURL(event.data)
            })
        }

        main()
    </script>
</body>
</html>
